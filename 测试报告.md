# 测试报告
## 1. 环境说明
本文的环境说明参考SPEC2017生成的测试报告，提取测试报告中相对应的环境说明。
### 1.1 硬件环境
 下表为 **lscpu from util-linux 2.37.2** 的内容
|项目    | 说明 |     项目 |    说明|
| :----- | :--: | :-------| :--:|
| Architecture |  sw_64 | Socket(s) | 2 |
|CPU op-mode(s) |  64-bit  | CPU max MHz | 2000.0000|
|  Address sizes |  48 bits physical, 53 bits virtual  | CPU min MHz | 1200.0000|
|Byte Order  | Little Endian | BogoMIPS | 4000.00 | 
|CPU(s) |256 | Flags | fpu simd vpn upn cpuid |
|On-line CPU(s) list |  0-255 | L1d cache | 16 MiB (256 instances) |
|Vendor ID | sunway | L1i cache | 16 MiB (256 instances) |
|Model name | WX-H8000 CPU @ 2.00GHz | L2 cache | 128 MiB (256 instances) |
|CPU family | 8 |  L3 cache | 256 MiB (2 instances) | 
|Model |  65 | NUMA node(s) |  2 |
|Thread(s) per core | 2 | NUMA node0 CPU(s) | 0-63,128-191 |
|Core(s) per socket | 64 | NUMA node1 CPU(s) | 64-127,192-255 |

下表为 **lscpu --cache** 的内容
|NAME | ONE-SIZE | ALL-SIZE | WAYS | TYPE | LEVEL | SETS | PHY-LINE | COHERENCY-SIZE |
| :--- | --: | --: | --: | :-- | --: | --: | :-: | --: |
|L1d | 64K | 16M | 8 | Data | 1 | 64 |   | 128 | 
|L1i | 64K | 16M | 8 |  Instruction | 1 | 64 |  | 128 |
|L2  | 512K | 128M | 8 | Unified | 2 | 512 |  | 128 |
|L3 |  128M | 256M | 8 | Unified  | 3 | 131072 |  | 128 |
### 1.2 软件环境
下表为 **Software** 的说明
| 项目 | 说明 |
| :--- | :----|
| OS | UOS Server 20   4.19.90-2409.6.0.0297.95.uel20.8a.sw_64  |
| Compiler |   C/C++/Fortran: Version 6.2.0 of GCC, the GNU Compiler Collection |
| Parallel | No |
| Firmware |    |
| File System | ext4 |
| System State | Run level 5 (add definition here) |
| Base Pointers | 64-bit | 
| Peak Pointers |  Not Applicable |
| Other |  |
| Power Management | -- |



## 2. 模型部署
模型部署的目的是将模型部署到WH-8000的CPU上，以便在真实环境中进行推理和演绎。本测试过程中采用llama.cpp来部署并运行merged_model.gguf，随后通过修改.bashrc文件来实现特定函数的调用。
### 2.1 在机器上安装llama.cpp
安装步骤首先为：
```bash
git clone https://github.com/ggml-org/llama.cpp
cd llama.cpp
```
之后为构建llama.cpp
```bash
cmake -B build
cmake --build build --config Release
```
### 2.2 模型上传

将merged_model.gguf 模型上传到/home/ainiforever/

### 2.3 修改 ~/.bashrc 文件
在 ~/.bashrc 中加入以下内容
```bash
export LLAMA_CPP_BIN=/home/ainiforever/llama.cpp/build/bin/llama-cli
export MY_LLAMA_MODEL=/home/ainiforever/merged_model.gguf   # 我的.gguf文件路径

ALLOWED_FLAGS=(
    "-mllvm -unroll-allow-partial -mllvm -allow-unroll-and-jam"
    "-mllvm -enable-unroll-and-jam"
    "-mllvm -unroll-optsize-threshold=200"
    "-mllvm -enable-misched -mllvm -misched-cluster"
    "-mllvm -misched-regpressure -mllvm -misched-fusion"
    "-mllvm -misched-cyclicpath"
    "-mllvm -enable-post-misched -mllvm -misched-postra"
    "-mllvm -enable-pipeliner -mllvm -pipeliner-prune-deps -mllvm -pipeliner-prune-loop-carried"
    "-mllvm -enable-loopinterchange"
    "-mllvm -unroll-threshold=300"
    "-mllvm -regalloc=greedy"
    "-mllvm -enable-load-in-loop-pre"
    "-mllvm -enable-loop-distribute -mllvm -extra-vectorizer-passes"
    "-mllvm -vectorize-loops -mllvm -force-vector-width=256"
    "-mllvm -vectorize-slp"
    "-mllvm -enable-epilogue-vectorization"
    "-mllvm -slp-vectorize-hor"
    "-mllvm -use-lir-code-size-heurs"
    "-mllvm -loop-distribute-non-if-convertibl"
    "-mllvm -loop-distribute-scev-check-threshold=256"
    "-mllvm -loop-interchange-threshold=20"
    "-mllvm -slp-vectorize-hor-store"
    "-mllvm -vectorizer-maximize-bandwidth"
    "-mllvm -unroll-runtime-other-exit-predictable"
    "-mllvm -unroll-allow-peeling"
)
optflags() {
    [ $# -ne 2 ] && { echo "usage: optflags <hw> <file>"; return 1; }
    # 用空格连接数组元素
    local flag_list="${ALLOWED_FLAGS[*]}"
    $LLAMA_CPP_BIN \
        -m "$MY_LLAMA_MODEL" \
        -p "<HARDWARE>: $1
<FUNCTION>:
$(cat "$2")

You may ONLY choose from the following LLVM optimization flags:
$flag_list

You must select **at least 9** LLVM flags from the above list.
Please return a **single line** containing **only the selected LLVM flags from the above list**, separated by spaces.
Do not invent new flags, do not modify their names, and do not add explanations."
}
```
之后运行 
```bash
之后运行optflags SW64 文件路径 
```
就可以调用模型推理
## 3. 测试方法描述
模型文件所在位置为
```bash
/home/ainiforever/merged_model.gguf
```
测试方法为：
使用 **newcode** 文件来修改 **~/.bashrc** 文件中的内容
```bash
/home/ainiforever/newcode 
```
之后应用 **llvm-run-hidden.patch** 文件来还原 **llvm-run-hidden.sh**
```bash
cd /home/ainiforever/experiment_1/leitaisai/
patch -p0 < llvm-run-hidden.patch
```
然后运行一下命令
```bash
optflags SW64 /home/ainiforever/experiment_1/leitaisai/spec2017-1.1.8-llvm/benchspec/CPU/500.perlbench_r/src/caretx.c
## 得到优化参数，复制优化参数
## 键盘输入 ctrl+C 结束模型对话
cd  /home/ainiforever/experiment_1/leitaisai/  ##转到相对应的目录进行测试
sh  llvm-run-hidden.sh  参数
```
同理，之后再运行一下 命令
```bash
optflags SW64 /home/ainiforever/experiment_1/leitaisai/spec2017-1.1.8-llvm/benchspec/CPU/531.deepsjeng_r/src/board.cpp
##  得到优化参数，复制优化参数
##  键盘输入 Ctrl + C 结束模型对话
cd  /home/ainiforever/experiment_1/leitaisai/  ##转到相对应的目录进行测试
sh  llvm-run-hidden.sh  参数
```
## 4. 测试结果分析
### 4.1 基准程序测试结果分析
第一次基准测试结果
| Benchmarks | Base Threads | Base Run Time | Base Ratio |
| :--- | ---: | ---: | ---: |
| 600.perlbench_s |  1 |  981 | 1.81 |
| 600.perlbench_s | 1 |  981 | 1.81 |
| 631.deepsjeng_s | 1 | 799 | 1.79 |
| 631.deepsjeng_s | 1 | 799 | 1.79 |

| benchmarks | compilation time | instructions |
| :---- | :----: | ----: |
| 600.perlbench_s | 20.37 秒 | 3772788327519 |
| 631.deepsjeng_s | 6.53 秒 | 2821297529687 |

第二次基准测试结果
| Benchmarks | Base Threads | Base Run Time | Base Ratio |
| :--- | ---: | ---: | ---: |
| 600.perlbench_s |  1 |  980 | 1.81 |
| 600.perlbench_s | 1 |  980 | 1.81 |
| 631.deepsjeng_s | 1 | 802 | 1.79 |
| 631.deepsjeng_s | 1 | 802 | 1.79 |

| benchmarks | compilation time | instructions |
| :---- | :----: | ----: |
| 600.perlbench_s | 20.36 秒 | 3772792132516 |
| 631.deepsjeng_s | 6.55 秒 | 2821294881510 |

### 4.2 加入优化参数后基准程序测试结果分析

根据**600.perlbench_s**源码，由大模型推理得出相应的优化参数，得到的测试结果。
| Benchmarks | Base Threads | Base Run Time | Base Ratio |
| :--- | ---: | ---: | ---: |
| 600.perlbench_s |  1 |  985 | 1.80 |
| 600.perlbench_s | 1 |  985 | 1.80 |
| 631.deepsjeng_s | 1 | 802 | 1.79 |
| 631.deepsjeng_s | 1 | 802 | 1.79 |

| benchmarks | compilation time | instructions |
| :---- | :----: | ----: |
| 600.perlbench_s | 20.34 秒 | 3772789437565 |
| 631.deepsjeng_s | 6.57 秒 | 2824472324435 |

根据**631.deepsjeng_s**源码，有大模型推理得到相应的优化参数，得到的测试结果。
| Benchmarks | Base Threads | Base Run Time | Base Ratio |
| :--- | ---: | ---: | ---: |
| 600.perlbench_s |  1 |  986 | 1.80 |
| 600.perlbench_s | 1 |  986 | 1.80 |
| 631.deepsjeng_s | 1 | 801 | 1.79 |
| 631.deepsjeng_s | 1 | 801 | 1.79 |

| benchmarks | compilation time | instructions |
| :---- | :----: | ----: |
| 600.perlbench_s | 20.29 秒 | 3772790592521 |
| 631.deepsjeng_s | 6.53 秒 | 2821294100541 |

## 5. 文件MD5值及路径和脚本代码

模型文件位置及MD5值
```bash
/home/ainiforever/merged_model.gguf  #模型文件位置
8aede3f73bf3ae2d5c4f9a2bab5b4a51  merged_model.gguf  # MD5值  
```
**newcode**文件的位置及MD5值
```bash
/home/ainiforever/newcode  #文件位置
97e81de9c2b14a291dd80a0e892c7294  newcode  #MD5值
```
**llvm-run-hidden.sh**文件的位置及MD5值
```bash
/home/ainiforever/experiment_1/leitaisai/llvm-run-hidden.sh #脚本文件的位置
54e0937fa2c6db150768d6d15f5742cd  llvm-run-hidden.sh  #MD5值
```
**llvm-run-hidden.patch** 文件的位置及MD5值
```bash
/home/ainiforever/experiment_1/leitaisai/llvm-run-hidden.patch #patch 文件的位置
92ef4c4bd9ed7a285529f49b337ef542  llvm-run-hidden.patch  #MD5值
```
其中 /home/ainiforever/experiment_1/leitaisai/llvm-run-hidden.patch 内容为
```bash
--- llvm-run-hidden-orign.sh    2025-08-19 04:55:19.520758725 +0800
+++ llvm-run-hidden.sh  2025-08-18 22:25:42.561705977 +0800
@@ -10,9 +10,22 @@
   export LD_LIBRARY_PATH=$LLVM_TOOL/lib

   env
-  sed -i "s#-O2#-O2 $@#g" ./config/llvm-2017-O2.cfg
+
+  # 把所有参数合并成字符串
+  Optflags="$*"
+  # 转义 sed 特殊字符（/、#）
+  safe_optflags=$(printf '%s' "$Optflags" | sed 's/[\/&]/\\&/g')
+
+
+  sed -i "s#-O2#-O2 $safe_optflags#g" ./config/llvm-2017-O2.cfg
   sh spec2017-llvm-run-hidden.sh;
-  sed -i "s#-O2 $@#-O2#g" ./config/llvm-2017-O2.cfg
+  sed -i "s#-O2 $safe_optflags#-O2#g" ./config/llvm-2017-O2.cfg
+
+
+
+#  sed -i "s#-O2#-O2 $@#g" ./config/llvm-2017-O2.cfg
+ # sh spec2017-llvm-run-hidden.sh;
+ # sed -i "s#-O2 $@#-O2#g" ./config/llvm-2017-O2.cfg
   tail -n 6 spectime-hidden.log | head -n 1 | awk '{print $2}' > compiler_600time.log
   compiler_600time=$(cat compiler_600time.log);
   tail -n 3 spectime-hidden.log | head -n 1 | awk '{print $2}' > compiler_631time.log
```